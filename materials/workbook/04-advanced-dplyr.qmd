---
title: "Data Transformation"
execute: 
  eval: true
  freeze: true
---

```{r, setup}
#| include: false

library(dplyr)
library(dbplyr)
```

## Catch up {.unnumbered}

```{r}
library(dplyr)
library(dbplyr)
library(DBI)

con <- dbConnect(
  odbc::databricks(),
  HTTPPath = "/sql/1.0/warehouses/300bd24ba12adf8e"
)

customers <- tbl(con, I("samples.tpch.customer"))
nation <- tbl(con, I("samples.tpch.nation"))
```

## Prepare base 
*Building the base variable/query*

1. Load the `orders` table in a variable called `orders`

```{r}
orders <- tbl(con, I("samples.tpch.orders"))
```

2. Join `orders` to the `customers` variable (table). Relate them on the
`o_custkey` and `c_custkey` fields.

```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey"))
```

2. Join `orders` to the `customers` variable (table). Relate them on the
`o_custkey` and `c_custkey` fields.

```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey"))
```

```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey")) %>% 
  mutate(customer = o_custkey, order_year = year(o_orderdate), order_month = month(o_orderdate))
```
```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey")) %>% 
  mutate(customer = o_custkey, order_year = year(o_orderdate), order_month = month(o_orderdate)) %>% 
  select(customer, everything()) 
```

```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey")) %>% 
  mutate(customer = o_custkey, order_year = year(o_orderdate), order_month = month(o_orderdate)) %>% 
  select(customer, everything(), -ends_with("comment")) 
```

```{r}
orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey")) %>% 
  mutate(customer = o_custkey, order_year = year(o_orderdate), order_month = month(o_orderdate)) %>% 
  select(customer, everything(), -ends_with("comment"), -ends_with("key")) 
```


```{r}
prep_orders <- orders %>% 
  left_join(customers, by = c("o_custkey" = "c_custkey")) %>% 
  left_join(nation, by = c("c_nationkey" = "n_nationkey")) %>% 
  mutate(customer = o_custkey, order_year = year(o_orderdate), order_month = month(o_orderdate)) %>% 
  select(customer, everything(), -ends_with("comment"), -ends_with("key")) 
```

```{r}
prep_orders %>% 
  glimpse()
```
## Answering questions
*Using the base query to answer more complex questions*

1. What are the top 5 countries for total amount ordered?

```{r}
prep_orders %>% 
  group_by(n_name) %>% 
  summarise(
    total_price = sum(o_totalprice, na.rm = TRUE)
  ) %>% 
  arrange(desc(total_price)) %>% 
  head(5)
```
2. What are the top 5 countries for total amount ordered for 1998?

```{r}
prep_orders %>% 
  filter(order_year == 1998) %>% 
  group_by(n_name) %>% 
  summarise(
    total_price = sum(o_totalprice, na.rm = TRUE)
  ) %>% 
  arrange(desc(total_price)) %>% 
  head(5)
```

3. What has been the top (1) country, in orders, by year?

```{r}
prep_orders %>% 
  group_by(n_name, order_year) %>% 
  summarise(
    total_price = sum(o_totalprice, na.rm = TRUE)
  ) %>% 
  group_by(order_year) %>% 
  filter(total_price == max(total_price))
```
4. Who are the top 5 customers by amount ordered?

```{r}
prep_orders %>% 
  group_by(customer) %>% 
  summarise(
    total_price = sum(o_totalprice, na.rm = TRUE)
    ) %>% 
  arrange(desc(total_price)) %>% 
  head(5)
```

5. What is the country, and market segment, of the top 5 customers by amount ordered?

```{r}
prep_orders %>% 
  group_by(customer) %>% 
  summarise(
    country = first(n_name), 
    segment = first(c_mktsegment),
    total_price = sum(o_totalprice, na.rm = TRUE)
    ) %>% 
  arrange(desc(total_price)) %>% 
  head(5)
```

