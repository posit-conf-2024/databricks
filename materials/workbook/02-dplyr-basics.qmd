---
title: "dplyr basics"
execute: 
  eval: true
  freeze: true
---


```{r, setup}
#| include: false
library(dplyr)
library(dbplyr)
library(DBI)
```

## Create a table variable

*Basics to how to point a variable in R to a table or view inside the database*

1. Load the `dplyr`, `DBI` and `dbplyr` libraries
```{r, dplyr}
library(dplyr)
library(dbplyr)
library(DBI)
```

2. *(Optional)* Open a connection to the database if it's currently closed
```{r}
con <- dbConnect(
  odbc::databricks(),
  HTTPPath = "/sql/1.0/warehouses/300bd24ba12adf8e"
)
```

3. Using `dbGetQuery()` create a query that pulls the top 10 rows form `cars`

```{r}
dbGetQuery(con, "select * from cars")
```

4. Use the `tbl()` to perform the same. Notice how it automatically only shows 
the top 10
```{r}
tbl(con, "cars")
```

4. Load the reference, not the table data, into a variable
```{r}
tbl_cars <- tbl(con, "cars")
```


5. Call the variable to see preview the data in the table
```{r}
tbl_cars
```

6. Add `count()` to easily get the number of rows
```{r}
tbl_cars %>% 
  count()
```

7. Add `am` as an argument to `count()` to see the count by that field
```{r}
tbl_cars %>% 
  count(am)
```

8. Add `show_query()` to see the how `dplyr` translates your code to 
SQL 

```{r}
tbl_cars %>% 
  count(am) %>% 
  show_query()
```
## Easily aggretate data
*An example of how we can use the same code against a local R data frame and a remote table*

1. Using `dplyr`, get the average `mpg` for each `am`, and sort it by the
average for `mtcars`

```{r}
mtcars %>% 
  group_by(cyl) %>% 
  summarise(avg_mpg = mean(mpg, na.rm = TRUE)) %>% 
  arrange(desc(avg_mpg))
```

2. Use `tbl_cars` to perform the exact same operation 

```{r}
tbl_cars %>% 
  group_by(cyl) %>% 
  summarise(avg_mpg = mean(mpg, na.rm = TRUE)) %>% 
  arrange(desc(avg_mpg))
```

3. Add `show_query()` to see what R sent to Databricks

```{r}
tbl_cars %>% 
  group_by(cyl) %>% 
  summarise(avg_mpg = mean(mpg, na.rm = TRUE)) %>% 
  arrange(desc(avg_mpg)) %>%
  show_query()
```
